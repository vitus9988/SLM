name: build-arm64-image

# main 브랜치 푸시·PR 때 동작
on:
  push:
    branches: [main]
  pull_request:

env:
  IMAGE_NAME: vitus9988/llamacpp-openblas
  PLATFORMS: linux/arm64             # 라즈베리파이 5 아키텍처

jobs:
  build:
    runs-on: ubuntu-22.04            # GitHub-hosted 22.04 러너
    steps:
      # 1) 소스 체크아웃
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) QEMU (ARM 에뮬) + Buildx 빌더 설정
      - name: Set up QEMU (arm64)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4) Dockerfile 빌드 & 푸시
      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          # Dockerfile이 들어 있는 폴더를 빌드 컨텍스트로 지정
          context: ./base_setting/docker
          # 괄호를 포함한 파일명을 작은따옴표로 감싸 명시
          file: './base_setting/docker/Dockerfile(llamacpp-OpenBLAS)'
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:test
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            CMAKE_VERSION=4.0.2
